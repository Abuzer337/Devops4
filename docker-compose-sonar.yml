version: '3.8'

services:
  # SonarQube —Å–µ—Ä–≤–µ—Ä
  sonarqube:
    image: sonarqube:9.9-community
    container_name: sonarqube-server
    ports:
      - "9000:9000"
    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://sonar-db:5432/sonar
      - SONAR_JDBC_USERNAME=sonar
      - SONAR_JDBC_PASSWORD=sonar
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
    depends_on:
      - sonar-db
    networks:
      - sonar-network

  # PostgreSQL –¥–ª—è SonarQube
  sonar-db:
    image: postgres:13
    container_name: sonar-database
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar
      - POSTGRES_DB=sonar
    volumes:
      - postgresql_data:/var/lib/postgresql/data
    networks:
      - sonar-network

  # –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∫–æ–¥–∞ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–¥ –∏–∑ GitHub
  sonar-analyzer:
    image: gradle:8.5-jdk17
    container_name: sonar-analyzer
    working_dir: /app
    environment:
      - SONAR_HOST_URL=http://sonarqube:9000
      - SONAR_LOGIN=squ_47bce0deb9f4aa76523c0609bae2b8e7d0272903
      - SONAR_PROJECT_KEY=devops:DevOps
      - GITHUB_REPO=https://github.com/Abuzer337/Devops4.git
      - TELEGRAM_BOT_TOKEN=8214582880:AAFnIB94F9bH-m6SNRNR9ktGph5lGW_ZSZs
      - TELEGRAM_CHAT_ID=931340901
    volumes:
      - ./sonar-analysis.sh:/app/sonar-analysis.sh:ro
      - gradle_cache:/root/.gradle
    command: >
      bash -c "
        echo 'üöÄ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ SonarQube...' &&
        echo '‚è∞ –í—Ä–µ–º—è: $(date)' &&
        echo 'üìÅ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${GITHUB_REPO}' &&
        echo '' &&
        
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        apt-get update && apt-get install -y git curl jq &&
        
        # –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        echo 'üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è...' &&
        git clone ${GITHUB_REPO} devops-backend &&
        cd devops-backend &&
        
        # –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ SonarQube
        echo '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ SonarQube...' &&
        until curl -s http://sonarqube:9000/api/system/status | jq -r '.status' | grep -q 'UP'; do
          echo 'SonarQube –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤, –∂–¥–µ–º...' &&
          sleep 10
        done &&
        echo '‚úÖ SonarQube –≥–æ—Ç–æ–≤!' &&
        
        # –°–±–æ—Ä–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑
        echo 'üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞...' &&
        ./gradlew clean build test --continue &&
        
        echo 'üìä –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ SonarQube...' &&
        ./gradlew sonar \
          -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
          -Dsonar.host.url=${SONAR_HOST_URL} \
          -Dsonar.login=${SONAR_LOGIN} \
          -Dsonar.qualitygate.wait=true &&
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
        echo 'üì± –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram...' &&
        curl -s -X POST 'https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage' \
          -d 'chat_id=${TELEGRAM_CHAT_ID}' \
          -d 'text=üéâ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–ï–ù! –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${GITHUB_REPO} –ê–Ω–∞–ª–∏–∑: –£–°–ü–ï–®–ù–û Dashboard: http://89.169.128.126:9000/dashboard?id=${SONAR_PROJECT_KEY}' \
          -d 'parse_mode=HTML' &&
        
        echo '‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!' &&
        echo 'üîó –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: ${SONAR_HOST_URL}/dashboard?id=${SONAR_PROJECT_KEY}'
      "
    depends_on:
      - sonarqube
    networks:
      - sonar-network
    restart: unless-stopped

  # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ SonarQube
  sonar-monitor:
    image: curlimages/curl:latest
    container_name: sonar-monitor
    environment:
      - SONAR_HOST_URL=http://sonarqube:9000
      - TELEGRAM_BOT_TOKEN=8214582880:AAFnIB94F9bH-m6SNRNR9ktGph5lGW_ZSZs
      - TELEGRAM_CHAT_ID=931340901
    command: >
      bash -c "
        echo 'üîç –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ SonarQube...' &&
        while true; do
          echo '‚è∞ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞: $(date)' &&
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ SonarQube
          STATUS=$$(curl -s http://sonarqube:9000/api/system/status | jq -r '.status' 2>/dev/null || echo 'DOWN') &&
          
          if [ \"$$STATUS\" = \"UP\" ]; then
            echo '‚úÖ SonarQube —Ä–∞–±–æ—Ç–∞–µ—Ç' &&
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ Quality Gate
            QG_STATUS=$$(curl -s 'http://sonarqube:9000/api/qualitygates/project_status?projectKey=devops:DevOps' | jq -r '.projectStatus.status' 2>/dev/null || echo 'UNKNOWN') &&
            
            if [ \"$$QG_STATUS\" = \"OK\" ]; then
              echo '‚úÖ Quality Gate: –ü–†–û–ô–î–ï–ù' &&
              curl -s -X POST 'https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage' \
                -d 'chat_id=${TELEGRAM_CHAT_ID}' \
                -d 'text=‚úÖ <b>QUALITY GATE –ü–†–û–ô–î–ï–ù!</b>

üéØ –ü—Ä–æ–µ–∫—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—Å–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞!' \
                -d 'parse_mode=HTML' 2>/dev/null || true
            else
              echo '‚ùå Quality Gate: –ù–ï –ü–†–û–ô–î–ï–ù ($$QG_STATUS)' &&
              curl -s -X POST 'https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage' \
                -d 'chat_id=${TELEGRAM_CHAT_ID}' \
                -d 'text=‚ùå <b>QUALITY GATE –ù–ï –ü–†–û–ô–î–ï–ù!</b>

üîç –°—Ç–∞—Ç—É—Å: $$QG_STATUS
üîó –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: http://89.169.128.126:9000/dashboard?id=devops:DevOps' \
                -d 'parse_mode=HTML' 2>/dev/null || true
            fi
          else
            echo '‚ùå SonarQube –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω' &&
            curl -s -X POST 'https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage' \
              -d 'chat_id=${TELEGRAM_CHAT_ID}' \
              -d 'text=‚ùå <b>SONARQUBE –ù–ï–î–û–°–¢–£–ü–ï–ù!</b>

üîç –°—Ç–∞—Ç—É—Å: $$STATUS
‚è∞ –í—Ä–µ–º—è: $(date)' \
              -d 'parse_mode=HTML' 2>/dev/null || true
          fi &&
          
          echo '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ 5 –º–∏–Ω—É—Ç...' &&
          sleep 300
        done
      "
    depends_on:
      - sonarqube
    networks:
      - sonar-network
    restart: unless-stopped

volumes:
  sonarqube_data:
  sonarqube_extensions:
  sonarqube_logs:
  postgresql_data:
  gradle_cache:

networks:
  sonar-network:
    driver: bridge
